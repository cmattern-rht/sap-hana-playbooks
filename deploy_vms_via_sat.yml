- name: deploy vms via satellite
  hosts: localhost
  gather_facts: no
#  collections:
#    -  theforeman.foreman
  vars:
    vm_prefix: lab1vm

  tasks:
#    - name: create host via satellite
#      host:
#        server_url: "{{ lookup('env', 'FOREMAN_SERVER') }}"
#        username: "{{ lookup('env', 'FOREMAN_USER') }}"
#        password: "{{ lookup('env', 'FOREMAN_PASSWORD') }}"
#        name: "{{ vm_name }}.{{ domain_name }}"
#        hostgroup: "{{ sat_host_group }}"
#        managed: true
#        build: true
#        location: Chattanooga
#        organization: Shadow Man
#        state: present

    - name: deploy vms via satellite (3)
      uri:
        url: "{{ lookup('env', 'FOREMAN_SERVER') }}/api/v2/hosts"
        user: "{{ lookup('env', 'FOREMAN_USER') }}"
        password: "{{ lookup('env', 'FOREMAN_PASSWORD') }}"
        validate_certs: false
        force_basic_auth: true
        timeout: 14400
        method: POST
        body_format: json
        body:
          host:
            name: "{{ vm_prefix + '%02d'|format(vm|int) }}"
            managed: "true"
            build: "true"
            hostgroup_id: "{{ hostgroup_id | default('16') }}"
            location_id: "{{ location_id | default('2') }}"
            organization_id: "{{ organization_id | default('1') }}"
            compute_attributes:
              start: '1'
      register: deploy_status
      until: ('Unable to set DNS entry' not in (deploy_status.json.error.erros.base[0] | default('')))
      delay: 5
      retries: 20
      changed_when:
        - deploy_status.status | int == 201
      failed_when:
        - deploy_status.status | int != 201
        - deploy_status.json.error.full_messages is defined
        - "'Name has already been taken' not in deploy_status.json.error.full_messages"
      loop: "{{ range(1, 3 + 1, 1)|list }}"
      loop_control:
        loop_var: vm